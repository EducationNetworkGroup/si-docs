"use strict";(self.webpackChunkscience_island_docs=self.webpackChunkscience_island_docs||[]).push([[1818],{4701:(e,s,n)=>{n.r(s),n.d(s,{assets:()=>d,contentTitle:()=>l,default:()=>u,frontMatter:()=>o,metadata:()=>r,toc:()=>t});const r=JSON.parse('{"id":"guides/cloud-environment/infrastructure-guide","title":"Infrastructure Guide","description":"Complete guide to Science Island\'s infrastructure-as-code repository","source":"@site/docs/03-guides/02-cloud-environment/03-infrastructure-guide.md","sourceDirName":"03-guides/02-cloud-environment","slug":"/guides/cloud-environment/infrastructure-guide","permalink":"/si-docs/guides/cloud-environment/infrastructure-guide","draft":false,"unlisted":false,"editUrl":"https://github.com/EducationNetworkGroup/si-docs/tree/main/docs/03-guides/02-cloud-environment/03-infrastructure-guide.md","tags":[],"version":"current","sidebarPosition":3,"frontMatter":{"sidebar_position":3,"description":"Complete guide to Science Island\'s infrastructure-as-code repository"},"sidebar":"tutorialSidebar","previous":{"title":"Pulumi (TypeScript)","permalink":"/si-docs/guides/cloud-environment/pulumi"},"next":{"title":"AWS \u2192 GCP Migration","permalink":"/si-docs/category/aws--gcp-migration"}}');var c=n(4848),i=n(8453);const o={sidebar_position:3,description:"Complete guide to Science Island's infrastructure-as-code repository"},l="Infrastructure Guide",d={},t=[{value:"What is si-infrastructure?",id:"what-is-si-infrastructure",level:2},{value:"Repository Structure",id:"repository-structure",level:2},{value:"Quick Setup",id:"quick-setup",level:2},{value:"Prerequisites",id:"prerequisites",level:3},{value:"Installation",id:"installation",level:3},{value:"GCP Modules",id:"gcp-modules",level:2},{value:"Compute Module (<code>src/gcp/compute/</code>)",id:"compute-module-srcgcpcompute",level:3},{value:"DNS Module (<code>src/gcp/dns/</code>)",id:"dns-module-srcgcpdns",level:3},{value:"IAM Module (<code>src/gcp/iam/</code>)",id:"iam-module-srcgcpiam",level:3},{value:"Storage Module (<code>src/gcp/storage/</code>)",id:"storage-module-srcgcpstorage",level:3},{value:"Common Workflows",id:"common-workflows",level:2},{value:"Deploy Service Update",id:"deploy-service-update",level:3},{value:"Add DNS Record",id:"add-dns-record",level:3},{value:"Deploy from Scratch",id:"deploy-from-scratch",level:3},{value:"Rotate Credentials",id:"rotate-credentials",level:3},{value:"Rollback Deployment",id:"rollback-deployment",level:3},{value:"Troubleshooting",id:"troubleshooting",level:2},{value:"Pulumi Issues",id:"pulumi-issues",level:3},{value:"GCP Issues",id:"gcp-issues",level:3},{value:"Service Issues",id:"service-issues",level:3},{value:"DNS Issues",id:"dns-issues",level:3},{value:"Emergency Procedures",id:"emergency-procedures",level:2}];function a(e){const s={code:"code",h1:"h1",h2:"h2",h3:"h3",header:"header",li:"li",p:"p",pre:"pre",strong:"strong",ul:"ul",...(0,i.R)(),...e.components};return(0,c.jsxs)(c.Fragment,{children:[(0,c.jsx)(s.header,{children:(0,c.jsx)(s.h1,{id:"infrastructure-guide",children:"Infrastructure Guide"})}),"\n",(0,c.jsx)(s.h2,{id:"what-is-si-infrastructure",children:"What is si-infrastructure?"}),"\n",(0,c.jsxs)(s.p,{children:["The ",(0,c.jsx)(s.code,{children:"si-infrastructure"})," repository uses ",(0,c.jsx)(s.strong,{children:"Pulumi"})," (Infrastructure-as-Code) to manage all Science Island cloud resources on ",(0,c.jsx)(s.strong,{children:"Google Cloud Platform"}),". All services run on a single GCP Compute Engine VM using Docker Compose."]}),"\n",(0,c.jsx)(s.p,{children:(0,c.jsx)(s.strong,{children:"Key Info:"})}),"\n",(0,c.jsxs)(s.ul,{children:["\n",(0,c.jsxs)(s.li,{children:[(0,c.jsx)(s.strong,{children:"Repository:"})," ",(0,c.jsx)(s.code,{children:"si-infrastructure"})]}),"\n",(0,c.jsxs)(s.li,{children:[(0,c.jsx)(s.strong,{children:"Tool:"})," Pulumi (TypeScript)"]}),"\n",(0,c.jsxs)(s.li,{children:[(0,c.jsx)(s.strong,{children:"Cloud:"})," Google Cloud Platform"]}),"\n",(0,c.jsxs)(s.li,{children:[(0,c.jsx)(s.strong,{children:"Services:"})," Platform, Website, Keycloak, Curriculum Mapper"]}),"\n"]}),"\n",(0,c.jsx)(s.h2,{id:"repository-structure",children:"Repository Structure"}),"\n",(0,c.jsx)(s.pre,{children:(0,c.jsx)(s.code,{children:"si-infrastructure/\n\u251c\u2500\u2500 src/gcp/\n\u2502   \u251c\u2500\u2500 compute/    # VM + Docker services\n\u2502   \u251c\u2500\u2500 dns/        # Domain routing\n\u2502   \u251c\u2500\u2500 iam/        # Service accounts\n\u2502   \u2514\u2500\u2500 storage/    # Cloud Storage buckets\n\u251c\u2500\u2500 Pulumi.prod.yaml  # Encrypted config\n\u2514\u2500\u2500 scripts/          # Utility scripts\n"})}),"\n",(0,c.jsx)(s.h2,{id:"quick-setup",children:"Quick Setup"}),"\n",(0,c.jsx)(s.h3,{id:"prerequisites",children:"Prerequisites"}),"\n",(0,c.jsx)(s.pre,{children:(0,c.jsx)(s.code,{className:"language-bash",children:"# Required tools\n- Pulumi CLI\n- Node.js v18+\n- Yarn\n- GCP SDK (gcloud)\n- Git\n\n# Required access\n- PULUMI_CONFIG_PASSPHRASE (ask Team Lead)\n- GitHub repo access\n- GCP project access (science-island-465603)\n"})}),"\n",(0,c.jsx)(s.h3,{id:"installation",children:"Installation"}),"\n",(0,c.jsx)(s.pre,{children:(0,c.jsx)(s.code,{className:"language-bash",children:"# 1. Clone and install\ngit clone https://github.com/EducationNetworkGroup/si-infrastructure.git\ncd si-infrastructure\nyarn install\n\n# 2. Authenticate GCP\ngcloud auth application-default login\ngcloud config set project science-island-465603\n\n# 3. Configure Pulumi\nexport PULUMI_CONFIG_PASSPHRASE=\"<from-team-lead>\"\npulumi login 'gs://si-iac-state'\n\n# 4. Test access\ncd src/gcp/compute\npulumi stack select organization/prod\npulumi preview\n"})}),"\n",(0,c.jsx)(s.h2,{id:"gcp-modules",children:"GCP Modules"}),"\n",(0,c.jsxs)(s.h3,{id:"compute-module-srcgcpcompute",children:["Compute Module (",(0,c.jsx)(s.code,{children:"src/gcp/compute/"}),")"]}),"\n",(0,c.jsxs)(s.p,{children:[(0,c.jsx)(s.strong,{children:"What it does:"})," Runs all services on a VM via Docker Compose"]}),"\n",(0,c.jsx)(s.p,{children:(0,c.jsx)(s.strong,{children:"Key resources:"})}),"\n",(0,c.jsxs)(s.ul,{children:["\n",(0,c.jsx)(s.li,{children:"Compute Engine VM (Ubuntu, e2-standard-2)"}),"\n",(0,c.jsx)(s.li,{children:"Filestore (NFS persistent storage)"}),"\n",(0,c.jsx)(s.li,{children:"VPC + Firewall (HTTP/HTTPS/SSH)"}),"\n",(0,c.jsx)(s.li,{children:"Docker Compose with 7+ services"}),"\n"]}),"\n",(0,c.jsx)(s.p,{children:(0,c.jsx)(s.strong,{children:"Common tasks:"})}),"\n",(0,c.jsx)(s.pre,{children:(0,c.jsx)(s.code,{className:"language-bash",children:"# Deploy version update\ncd src/gcp/compute\n# Edit Pulumi.prod.yaml: deployed-versions.si-platform-backend.image: v1.2.3\npulumi up\n\n# SSH into VM\n./ssh-into-instance.sh\nsudo docker compose ps\nsudo docker compose logs -f <service-name>\n\n# Restart service\nsudo docker compose restart si-platform-backend\n"})}),"\n",(0,c.jsxs)(s.h3,{id:"dns-module-srcgcpdns",children:["DNS Module (",(0,c.jsx)(s.code,{children:"src/gcp/dns/"}),")"]}),"\n",(0,c.jsxs)(s.p,{children:[(0,c.jsx)(s.strong,{children:"What it does:"})," Routes domains to VM"]}),"\n",(0,c.jsx)(s.p,{children:(0,c.jsx)(s.strong,{children:"Managed records:"})}),"\n",(0,c.jsxs)(s.ul,{children:["\n",(0,c.jsx)(s.li,{children:"login.scienceisland.com"}),"\n",(0,c.jsx)(s.li,{children:"platform.scienceisland.com"}),"\n",(0,c.jsx)(s.li,{children:"mapper.scienceisland.com"}),"\n"]}),"\n",(0,c.jsx)(s.p,{children:(0,c.jsx)(s.strong,{children:"Common tasks:"})}),"\n",(0,c.jsx)(s.pre,{children:(0,c.jsx)(s.code,{className:"language-bash",children:"cd src/gcp/dns\npulumi up\n\n# Verify DNS\ndig platform.scienceisland.com\n"})}),"\n",(0,c.jsxs)(s.h3,{id:"iam-module-srcgcpiam",children:["IAM Module (",(0,c.jsx)(s.code,{children:"src/gcp/iam/"}),")"]}),"\n",(0,c.jsxs)(s.p,{children:[(0,c.jsx)(s.strong,{children:"What it does:"})," Service accounts for CI/CD"]}),"\n",(0,c.jsx)(s.pre,{children:(0,c.jsx)(s.code,{className:"language-bash",children:"cd src/gcp/iam\npulumi up\n"})}),"\n",(0,c.jsxs)(s.h3,{id:"storage-module-srcgcpstorage",children:["Storage Module (",(0,c.jsx)(s.code,{children:"src/gcp/storage/"}),")"]}),"\n",(0,c.jsxs)(s.p,{children:[(0,c.jsx)(s.strong,{children:"What it does:"})," Cloud Storage buckets for state & backups"]}),"\n",(0,c.jsx)(s.pre,{children:(0,c.jsx)(s.code,{className:"language-bash",children:"cd src/gcp/storage\npulumi up\n"})}),"\n",(0,c.jsx)(s.h2,{id:"common-workflows",children:"Common Workflows"}),"\n",(0,c.jsx)(s.h3,{id:"deploy-service-update",children:"Deploy Service Update"}),"\n",(0,c.jsx)(s.pre,{children:(0,c.jsx)(s.code,{className:"language-bash",children:"cd src/gcp/compute\n# Edit Pulumi.prod.yaml: change image version\npulumi preview\npulumi up\n"})}),"\n",(0,c.jsx)(s.h3,{id:"add-dns-record",children:"Add DNS Record"}),"\n",(0,c.jsx)(s.pre,{children:(0,c.jsx)(s.code,{className:"language-bash",children:"cd src/gcp/dns\n# Edit index.ts: add new RecordSet\npulumi up\n"})}),"\n",(0,c.jsx)(s.h3,{id:"deploy-from-scratch",children:"Deploy from Scratch"}),"\n",(0,c.jsx)(s.pre,{children:(0,c.jsx)(s.code,{className:"language-bash",children:"# Phase 1 (parallel)\ncd src/gcp/iam && pulumi up &\ncd src/gcp/storage && pulumi up &\ncd src/gcp/compute && pulumi up  # Takes ~10 min\n\n# Phase 2 (after compute)\ncd src/gcp/dns && pulumi up\n"})}),"\n",(0,c.jsx)(s.h3,{id:"rotate-credentials",children:"Rotate Credentials"}),"\n",(0,c.jsx)(s.pre,{children:(0,c.jsx)(s.code,{className:"language-bash",children:'cd src/gcp/compute\nNEW_PW=$(openssl rand -base64 24)\npulumi config set --secret postgres-password "$NEW_PW"\npulumi up\n'})}),"\n",(0,c.jsx)(s.h3,{id:"rollback-deployment",children:"Rollback Deployment"}),"\n",(0,c.jsx)(s.pre,{children:(0,c.jsx)(s.code,{className:"language-bash",children:"cd src/gcp/compute\npulumi stack history\npulumi stack export --version <previous-version> > state.json\npulumi stack import --file state.json\npulumi up\n"})}),"\n",(0,c.jsx)(s.h2,{id:"troubleshooting",children:"Troubleshooting"}),"\n",(0,c.jsx)(s.h3,{id:"pulumi-issues",children:"Pulumi Issues"}),"\n",(0,c.jsx)(s.p,{children:(0,c.jsx)(s.strong,{children:"Passphrase error:"})}),"\n",(0,c.jsx)(s.pre,{children:(0,c.jsx)(s.code,{className:"language-bash",children:'echo $PULUMI_CONFIG_PASSPHRASE  # Should output passphrase\nexport PULUMI_CONFIG_PASSPHRASE="<correct-passphrase>"\n'})}),"\n",(0,c.jsx)(s.p,{children:(0,c.jsx)(s.strong,{children:"Stack not found:"})}),"\n",(0,c.jsx)(s.pre,{children:(0,c.jsx)(s.code,{className:"language-bash",children:"pulumi login 'gs://si-iac-state'\npulumi stack select organization/prod\n"})}),"\n",(0,c.jsx)(s.h3,{id:"gcp-issues",children:"GCP Issues"}),"\n",(0,c.jsx)(s.p,{children:(0,c.jsx)(s.strong,{children:"Permission denied:"})}),"\n",(0,c.jsx)(s.pre,{children:(0,c.jsx)(s.code,{className:"language-bash",children:"gcloud auth application-default login\ngcloud config set project science-island-465603\n"})}),"\n",(0,c.jsx)(s.p,{children:(0,c.jsx)(s.strong,{children:"Can't SSH into VM:"})}),"\n",(0,c.jsx)(s.pre,{children:(0,c.jsx)(s.code,{className:"language-bash",children:"gcloud compute ssh si-compute-1 \\\n  --project=science-island-465603 \\\n  --zone=australia-southeast1-b\n"})}),"\n",(0,c.jsx)(s.h3,{id:"service-issues",children:"Service Issues"}),"\n",(0,c.jsx)(s.p,{children:(0,c.jsx)(s.strong,{children:"Service not starting:"})}),"\n",(0,c.jsx)(s.pre,{children:(0,c.jsx)(s.code,{className:"language-bash",children:"# SSH into VM\ncd /opt/app\nsudo docker compose logs <service-name>\nsudo docker compose restart <service-name>\n"})}),"\n",(0,c.jsx)(s.p,{children:(0,c.jsx)(s.strong,{children:"Database connection refused:"})}),"\n",(0,c.jsx)(s.pre,{children:(0,c.jsx)(s.code,{className:"language-bash",children:"sudo docker compose ps | grep postgres\nsudo docker compose logs postgres\nsudo docker compose restart postgres\n"})}),"\n",(0,c.jsx)(s.p,{children:(0,c.jsx)(s.strong,{children:"Filestore not mounted:"})}),"\n",(0,c.jsx)(s.pre,{children:(0,c.jsx)(s.code,{className:"language-bash",children:"df -h | grep /opt/app/data\n# Get IP from: pulumi stack output filestoreIp\nsudo mount -o nolock <filestore-ip>:/vol1 /opt/app/data/\n"})}),"\n",(0,c.jsx)(s.h3,{id:"dns-issues",children:"DNS Issues"}),"\n",(0,c.jsx)(s.p,{children:(0,c.jsx)(s.strong,{children:"DNS not resolving:"})}),"\n",(0,c.jsx)(s.pre,{children:(0,c.jsx)(s.code,{className:"language-bash",children:"# Verify DNS module deployed\ncd src/gcp/dns\npulumi stack output\n\n# Check records\ngcloud dns record-sets list --zone=scienceisland-com\n\n# Clear cache\ndig platform.scienceisland.com\n"})}),"\n",(0,c.jsx)(s.h2,{id:"emergency-procedures",children:"Emergency Procedures"}),"\n",(0,c.jsx)(s.p,{children:(0,c.jsx)(s.strong,{children:"Restart crashed service:"})}),"\n",(0,c.jsx)(s.pre,{children:(0,c.jsx)(s.code,{className:"language-bash",children:"./ssh-into-instance.sh\nsudo docker compose restart <service-name>\n"})}),"\n",(0,c.jsx)(s.p,{children:(0,c.jsx)(s.strong,{children:"Rebuild VM:"})}),"\n",(0,c.jsx)(s.pre,{children:(0,c.jsx)(s.code,{className:"language-bash",children:"cd src/gcp/compute\npulumi stack export > backup.json\npulumi destroy --target <vm-resource>\npulumi up\n"})})]})}function u(e={}){const{wrapper:s}={...(0,i.R)(),...e.components};return s?(0,c.jsx)(s,{...e,children:(0,c.jsx)(a,{...e})}):a(e)}},8453:(e,s,n)=>{n.d(s,{R:()=>o,x:()=>l});var r=n(6540);const c={},i=r.createContext(c);function o(e){const s=r.useContext(i);return r.useMemo((function(){return"function"==typeof e?e(s):{...s,...e}}),[s,e])}function l(e){let s;return s=e.disableParentContext?"function"==typeof e.components?e.components(c):e.components||c:o(e.components),r.createElement(i.Provider,{value:s},e.children)}}}]);