"use strict";(self.webpackChunkscience_island_docs=self.webpackChunkscience_island_docs||[]).push([[8639],{5522:(e,n,i)=>{i.r(n),i.d(n,{assets:()=>a,contentTitle:()=>d,default:()=>p,frontMatter:()=>s,metadata:()=>c,toc:()=>t});const c=JSON.parse('{"id":"tools-and-technologies/caddy/science-island-configuration","title":"Configuration","description":"Caddy configuration in Science Island infrastructure.","source":"@site/docs/02-tools-and-technologies/04-caddy/02-science-island-configuration.md","sourceDirName":"02-tools-and-technologies/04-caddy","slug":"/tools-and-technologies/caddy/science-island-configuration","permalink":"/si-docs/tools-and-technologies/caddy/science-island-configuration","draft":false,"unlisted":false,"editUrl":"https://github.com/EducationNetworkGroup/si-docs/tree/main/docs/02-tools-and-technologies/04-caddy/02-science-island-configuration.md","tags":[],"version":"current","sidebarPosition":2,"frontMatter":{"sidebar_position":2,"description":"Caddy configuration in Science Island infrastructure."},"sidebar":"tutorialSidebar","previous":{"title":"Overview","permalink":"/si-docs/tools-and-technologies/caddy/overview"},"next":{"title":"Working with Caddyfiles","permalink":"/si-docs/tools-and-technologies/caddy/working-with-caddyfiles"}}');var r=i(4848),o=i(8453);const s={sidebar_position:2,description:"Caddy configuration in Science Island infrastructure."},d="Configuration",a={},t=[{value:"Production (<code>prod.Caddyfile</code>)",id:"production-prodcaddyfile",level:2},{value:"Domain Routing",id:"domain-routing",level:3},{value:"Local Dev (<code>local.Caddyfile</code>)",id:"local-dev-localcaddyfile",level:2},{value:"Auth Service (<code>si-auth-service</code>)",id:"auth-service-si-auth-service",level:2},{value:"Deployment",id:"deployment",level:2},{value:"Production",id:"production",level:3},{value:"Local",id:"local",level:3},{value:"Service Discovery",id:"service-discovery",level:2}];function l(e){const n={code:"code",h1:"h1",h2:"h2",h3:"h3",header:"header",li:"li",p:"p",pre:"pre",strong:"strong",ul:"ul",...(0,o.R)(),...e.components};return(0,r.jsxs)(r.Fragment,{children:[(0,r.jsx)(n.header,{children:(0,r.jsx)(n.h1,{id:"configuration",children:"Configuration"})}),"\n",(0,r.jsxs)(n.h2,{id:"production-prodcaddyfile",children:["Production (",(0,r.jsx)(n.code,{children:"prod.Caddyfile"}),")"]}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.strong,{children:"Location"}),": ",(0,r.jsx)(n.code,{children:"si-infrastructure/src/gcp/compute/prod.Caddyfile"})]}),"\n",(0,r.jsx)(n.h3,{id:"domain-routing",children:"Domain Routing"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-caddy",children:'# Frontend services\nplatform.scienceisland.com {\n    reverse_proxy platform-client:3000\n}\n\nmapper.scienceisland.com {\n    reverse_proxy mapper-frontend:3000\n}\n\nscienceisland.com {\n    reverse_proxy website:80\n}\n\n# Auth with WebSocket support\nlogin.scienceisland.com {\n    header {\n        Strict-Transport-Security "max-age=31536000; includeSubDomains"\n        X-Frame-Options "SAMEORIGIN"\n    }\n    reverse_proxy keycloak:8080 {\n        header_up Connection {>Connection}\n        header_up Upgrade {>Upgrade}\n    }\n}\n\n# API Gateway - path-based routing\napi.scienceisland.com {\n    handle /api/v1/account* { reverse_proxy platform-account:8001 }\n    handle /api/v1/assignments* { reverse_proxy platform-assignment:8001 }\n    handle /api/v1/groups* { reverse_proxy platform-group:8001 }\n    handle /api/v1/mapper* { reverse_proxy mapper-backend:8088 }\n    handle /health { respond "Health OK" 200 }\n}\n'})}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.strong,{children:"Key Points"}),":"]}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"All services on port 8001 except mapper-backend (8088)"}),"\n",(0,r.jsx)(n.li,{children:"WebSocket headers required for Keycloak"}),"\n",(0,r.jsx)(n.li,{children:"Path-based routing for API gateway"}),"\n"]}),"\n",(0,r.jsxs)(n.h2,{id:"local-dev-localcaddyfile",children:["Local Dev (",(0,r.jsx)(n.code,{children:"local.Caddyfile"}),")"]}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.strong,{children:"Location"}),": ",(0,r.jsx)(n.code,{children:"si-infrastructure/src/gcp/compute/local.Caddyfile"})]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-caddy",children:":80, :443 {\n    tls internal\n    \n    @platform { host platform.* }\n    @mapper { host mapper.* }\n    @keycloak { host login.* }\n    @website { host scienceisland.* }\n    \n    handle @platform { reverse_proxy platform-client:3000 }\n    handle @mapper { reverse_proxy mapper-frontend:3000 }\n    handle @keycloak { reverse_proxy keycloak:8080 }\n    handle @website { reverse_proxy website:80 }\n}\n"})}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.strong,{children:"Differences"}),":"]}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"tls internal"})," uses self-signed certs"]}),"\n",(0,r.jsx)(n.li,{children:"Wildcard subdomain matching"}),"\n"]}),"\n",(0,r.jsxs)(n.h2,{id:"auth-service-si-auth-service",children:["Auth Service (",(0,r.jsx)(n.code,{children:"si-auth-service"}),")"]}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.strong,{children:"Location"}),": ",(0,r.jsx)(n.code,{children:"si-auth-service/caddy/Caddyfile"})]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-caddy",children:"{\n    admin off\n    auto_https disable_redirects\n}\n\nhttp://{$SERVER_NAME}, https://{$SERVER_NAME} {\n    encode gzip zstd\n    reverse_proxy keycloak:8080\n}\n"})}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.strong,{children:"Docker Integration"}),":"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-yaml",children:"keycloak-proxy:\n  build: ./caddy\n  environment:\n    SERVER_NAME: ${SERVER_NAME:-localhost}\n  volumes:\n    - caddy-data:/data\n  ports:\n    - 80:80\n    - 443:443\n"})}),"\n",(0,r.jsx)(n.h2,{id:"deployment",children:"Deployment"}),"\n",(0,r.jsx)(n.h3,{id:"production",children:"Production"}),"\n",(0,r.jsx)(n.p,{children:"Deployed via Pulumi:"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-typescript",children:'const caddyFileContents = fs.readFileSync("./prod.Caddyfile", "utf8");\n// Templated into startup script \u2192 written to /opt/app/Caddyfile\n'})}),"\n",(0,r.jsxs)(n.p,{children:["Changes require ",(0,r.jsx)(n.code,{children:"pulumi up"})," which recreates the VM."]}),"\n",(0,r.jsx)(n.h3,{id:"local",children:"Local"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-bash",children:"cd si-auth-service\ndocker compose up -d --build\n"})}),"\n",(0,r.jsx)(n.h2,{id:"service-discovery",children:"Service Discovery"}),"\n",(0,r.jsx)(n.p,{children:"Services communicate via Docker DNS:"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{children:"caddy \u2192 http://keycloak:8080\ncaddy \u2192 http://platform-client:3000\n"})}),"\n",(0,r.jsx)(n.p,{children:"All services must be on the same Docker network."})]})}function p(e={}){const{wrapper:n}={...(0,o.R)(),...e.components};return n?(0,r.jsx)(n,{...e,children:(0,r.jsx)(l,{...e})}):l(e)}},8453:(e,n,i)=>{i.d(n,{R:()=>s,x:()=>d});var c=i(6540);const r={},o=c.createContext(r);function s(e){const n=c.useContext(o);return c.useMemo((function(){return"function"==typeof e?e(n):{...n,...e}}),[n,e])}function d(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(r):e.components||r:s(e.components),c.createElement(o.Provider,{value:n},e.children)}}}]);