"use strict";(self.webpackChunkscience_island_docs=self.webpackChunkscience_island_docs||[]).push([[7599],{5380:(e,n,d)=>{d.r(n),d.d(n,{assets:()=>r,contentTitle:()=>o,default:()=>h,frontMatter:()=>c,metadata:()=>i,toc:()=>l});const i=JSON.parse('{"id":"tools-and-technologies/caddy/working-with-caddyfiles","title":"Working with Caddyfiles","description":"How to modify Caddy configurations.","source":"@site/docs/02-tools-and-technologies/04-caddy/03-working-with-caddyfiles.md","sourceDirName":"02-tools-and-technologies/04-caddy","slug":"/tools-and-technologies/caddy/working-with-caddyfiles","permalink":"/si-docs/tools-and-technologies/caddy/working-with-caddyfiles","draft":false,"unlisted":false,"editUrl":"https://github.com/EducationNetworkGroup/si-docs/tree/main/docs/02-tools-and-technologies/04-caddy/03-working-with-caddyfiles.md","tags":[],"version":"current","sidebarPosition":3,"frontMatter":{"sidebar_position":3,"description":"How to modify Caddy configurations."},"sidebar":"tutorialSidebar","previous":{"title":"Configuration","permalink":"/si-docs/tools-and-technologies/caddy/science-island-configuration"},"next":{"title":"KeyCloak","permalink":"/si-docs/category/keycloak"}}');var s=d(4848),a=d(8453);const c={sidebar_position:3,description:"How to modify Caddy configurations."},o="Working with Caddyfiles",r={},l=[{value:"Syntax Basics",id:"syntax-basics",level:2},{value:"Adding a New Service",id:"adding-a-new-service",level:2},{value:"1. Add to API Gateway",id:"1-add-to-api-gateway",level:3},{value:"2. Deploy",id:"2-deploy",level:3},{value:"Adding a New Subdomain",id:"adding-a-new-subdomain",level:2},{value:"1. Update Caddyfile",id:"1-update-caddyfile",level:3},{value:"2. Update DNS",id:"2-update-dns",level:3},{value:"3. Deploy",id:"3-deploy",level:3},{value:"Common Modifications",id:"common-modifications",level:2},{value:"Add Security Headers",id:"add-security-headers",level:3},{value:"Enable Compression",id:"enable-compression",level:3},{value:"Increase Timeout",id:"increase-timeout",level:3},{value:"Add CORS Headers",id:"add-cors-headers",level:3},{value:"Testing",id:"testing",level:2},{value:"Validate Syntax",id:"validate-syntax",level:3},{value:"Check Logs",id:"check-logs",level:3},{value:"Test Routes",id:"test-routes",level:3},{value:"Best Practices",id:"best-practices",level:2}];function t(e){const n={blockquote:"blockquote",code:"code",h1:"h1",h2:"h2",h3:"h3",header:"header",li:"li",ol:"ol",p:"p",pre:"pre",strong:"strong",...(0,a.R)(),...e.components};return(0,s.jsxs)(s.Fragment,{children:[(0,s.jsx)(n.header,{children:(0,s.jsx)(n.h1,{id:"working-with-caddyfiles",children:"Working with Caddyfiles"})}),"\n",(0,s.jsx)(n.h2,{id:"syntax-basics",children:"Syntax Basics"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-caddy",children:"# Domain block\ndomain.com {\n    reverse_proxy backend:8001\n}\n\n# Path-based routing\napi.domain.com {\n    handle /api/v1/users* {\n        reverse_proxy user-service:8001\n    }\n}\n\n# Named matchers\n@api {\n    path /api/*\n    method GET POST\n}\nhandle @api {\n    reverse_proxy backend:8001\n}\n"})}),"\n",(0,s.jsx)(n.h2,{id:"adding-a-new-service",children:"Adding a New Service"}),"\n",(0,s.jsx)(n.h3,{id:"1-add-to-api-gateway",children:"1. Add to API Gateway"}),"\n",(0,s.jsxs)(n.p,{children:["Edit ",(0,s.jsx)(n.code,{children:"prod.Caddyfile"}),":"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-caddy",children:"api.scienceisland.com {\n    # Add your new service\n    handle /api/v1/notifications* {\n        reverse_proxy platform-notification:8001\n    }\n}\n"})}),"\n",(0,s.jsx)(n.h3,{id:"2-deploy",children:"2. Deploy"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-bash",children:"cd si-infrastructure/src/gcp/compute\npulumi up\n"})}),"\n",(0,s.jsx)(n.p,{children:"This recreates the VM with the new config."}),"\n",(0,s.jsx)(n.h2,{id:"adding-a-new-subdomain",children:"Adding a New Subdomain"}),"\n",(0,s.jsx)(n.h3,{id:"1-update-caddyfile",children:"1. Update Caddyfile"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-caddy",children:"monitoring.scienceisland.com {\n    reverse_proxy grafana:3000\n}\n"})}),"\n",(0,s.jsx)(n.h3,{id:"2-update-dns",children:"2. Update DNS"}),"\n",(0,s.jsxs)(n.p,{children:["Add A record: ",(0,s.jsx)(n.code,{children:"monitoring.scienceisland.com"})," \u2192 ",(0,s.jsx)(n.code,{children:"<instance-ip>"})]}),"\n",(0,s.jsxs)(n.blockquote,{children:["\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.strong,{children:"Note"}),": To add the A record, contact Bill (CTO) who can work with the domain provider to configure the DNS settings. If this is your first time setting up a subdomain, don't hesitate to ask for guidance on the DNS configuration process."]}),"\n"]}),"\n",(0,s.jsx)(n.h3,{id:"3-deploy",children:"3. Deploy"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-bash",children:"pulumi up\n"})}),"\n",(0,s.jsx)(n.p,{children:"Caddy auto-provisions SSL certificates."}),"\n",(0,s.jsx)(n.h2,{id:"common-modifications",children:"Common Modifications"}),"\n",(0,s.jsx)(n.h3,{id:"add-security-headers",children:"Add Security Headers"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-caddy",children:'platform.scienceisland.com {\n    header {\n        X-Frame-Options "SAMEORIGIN"\n        X-Content-Type-Options "nosniff"\n    }\n    reverse_proxy platform-client:3000\n}\n'})}),"\n",(0,s.jsx)(n.h3,{id:"enable-compression",children:"Enable Compression"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-caddy",children:"domain.com {\n    encode gzip zstd\n    reverse_proxy backend:8001\n}\n"})}),"\n",(0,s.jsx)(n.h3,{id:"increase-timeout",children:"Increase Timeout"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-caddy",children:"reverse_proxy backend:8001 {\n    timeout 5m\n}\n"})}),"\n",(0,s.jsx)(n.h3,{id:"add-cors-headers",children:"Add CORS Headers"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-caddy",children:'handle /api/* {\n    header Access-Control-Allow-Origin "*"\n    \n    @options method OPTIONS\n    handle @options { respond 204 }\n    \n    reverse_proxy backend:8001\n}\n'})}),"\n",(0,s.jsx)(n.h2,{id:"testing",children:"Testing"}),"\n",(0,s.jsx)(n.h3,{id:"validate-syntax",children:"Validate Syntax"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-bash",children:"docker run --rm -v $(pwd)/prod.Caddyfile:/etc/caddy/Caddyfile caddy:2 caddy validate --config /etc/caddy/Caddyfile\n"})}),"\n",(0,s.jsx)(n.h3,{id:"check-logs",children:"Check Logs"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-bash",children:"docker compose logs -f caddy\n"})}),"\n",(0,s.jsx)(n.h3,{id:"test-routes",children:"Test Routes"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-bash",children:"curl https://api.scienceisland.com/health\ncurl -I https://platform.scienceisland.com\n"})}),"\n",(0,s.jsx)(n.h2,{id:"best-practices",children:"Best Practices"}),"\n",(0,s.jsxs)(n.ol,{children:["\n",(0,s.jsxs)(n.li,{children:["\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.strong,{children:"Specific paths first"}),": More specific ",(0,s.jsx)(n.code,{children:"handle"})," blocks before general ones"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-caddy",children:"handle /api/v1/users/me { ... }\nhandle /api/v1/users/* { ... }\n"})}),"\n"]}),"\n",(0,s.jsxs)(n.li,{children:["\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.strong,{children:"Validate before deploying"}),": ",(0,s.jsx)(n.code,{children:"caddy validate --config Caddyfile"})]}),"\n"]}),"\n",(0,s.jsxs)(n.li,{children:["\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.strong,{children:"Add comments"}),": Explain non-standard configs"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-caddy",children:"# Mapper backend uses port 8088 (Go default)\nhandle /api/v1/mapper* { reverse_proxy mapper-backend:8088 }\n"})}),"\n"]}),"\n",(0,s.jsxs)(n.li,{children:["\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.strong,{children:"Test locally"}),": Use ",(0,s.jsx)(n.code,{children:"local.Caddyfile"})," with Docker Compose first"]}),"\n"]}),"\n"]})]})}function h(e={}){const{wrapper:n}={...(0,a.R)(),...e.components};return n?(0,s.jsx)(n,{...e,children:(0,s.jsx)(t,{...e})}):t(e)}},8453:(e,n,d)=>{d.d(n,{R:()=>c,x:()=>o});var i=d(6540);const s={},a=i.createContext(s);function c(e){const n=i.useContext(a);return i.useMemo((function(){return"function"==typeof e?e(n):{...n,...e}}),[n,e])}function o(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(s):e.components||s:c(e.components),i.createElement(a.Provider,{value:n},e.children)}}}]);